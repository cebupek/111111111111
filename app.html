<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>ĞœĞ¾Ğ´ĞµÑ€Ğ°Ñ†Ğ¸Ñ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700&family=Mulish:wght@400;500;600&display=swap');

  :root {
    --bg:      #0a0a0f;
    --surface: #13131a;
    --card:    #1a1a25;
    --border:  #2a2a3a;
    --accent:  #7c5cfc;
    --green:   #22c55e;
    --red:     #ef4444;
    --yellow:  #f59e0b;
    --text:    #e8e8f0;
    --muted:   #6b6b85;
    --radius:  14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Mulish', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    overscroll-behavior: none;
  }

  /* â”€â”€ Ğ¨ĞĞŸĞšĞ â”€â”€ */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 12px 16px 0;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .logo {
    font-family: 'Unbounded', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: var(--text);
  }
  .logo span { color: var(--accent); }

  .queue-badge {
    background: var(--accent);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 9px;
    border-radius: 20px;
    min-width: 24px;
    text-align: center;
  }
  .queue-badge.empty { background: var(--border); color: var(--muted); }

  /* â”€â”€ Ğ¢ĞĞ‘Ğ« â”€â”€ */
  .tabs {
    display: flex;
    gap: 4px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }

  .tab {
    flex-shrink: 0;
    padding: 8px 14px;
    border-radius: 8px 8px 0 0;
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    cursor: pointer;
    border: none;
    background: none;
    position: relative;
    transition: color 0.15s;
  }
  .tab.active {
    color: var(--text);
  }
  .tab.active::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
    border-radius: 2px 2px 0 0;
  }

  /* â”€â”€ ĞšĞĞĞ¢Ğ•ĞĞ¢ â”€â”€ */
  .content {
    padding: 16px;
    display: none;
  }
  .content.active { display: block; }

  /* â”€â”€ ĞšĞĞ Ğ¢ĞĞ§ĞšĞ â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .card.handled {
    opacity: 0.5;
    pointer-events: none;
  }
  .card-accent-line {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--accent);
    border-radius: 3px 0 0 3px;
  }
  .card-accent-line.green { background: var(--green); }
  .card-accent-line.red   { background: var(--red); }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }
  .card-type {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .card-id {
    font-size: 11px;
    color: var(--muted);
    font-family: monospace;
  }

  .card-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 13px;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 4px;
    color: var(--text);
  }
  .card-title.unknown { color: var(--yellow); }

  .card-meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .card-meta span { color: var(--text); opacity: 0.7; }

  /* â”€â”€ ĞŸĞ›Ğ•Ğ•Ğ  â”€â”€ */
  .player {
    background: var(--surface);
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .play-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: transform 0.1s, opacity 0.2s;
  }
  .play-btn:active { transform: scale(0.92); }
  .play-btn.loading { opacity: 0.6; pointer-events: none; }

  .player-info { flex: 1; min-width: 0; }
  .player-title {
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }
  .player-bar {
    height: 3px;
    background: var(--border);
    border-radius: 3px;
    position: relative;
    cursor: pointer;
  }
  .player-progress {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    width: 0%;
    transition: width 0.3s linear;
  }
  .player-time {
    font-size: 10px;
    color: var(--muted);
    margin-top: 3px;
  }

  /* â”€â”€ ĞĞ‘Ğ›ĞĞ–ĞšĞ â”€â”€ */
  .cover-img {
    width: 100%;
    border-radius: 10px;
    margin-bottom: 12px;
    max-height: 200px;
    object-fit: cover;
    background: var(--surface);
  }

  /* â”€â”€ ĞšĞĞĞŸĞšĞ˜ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ™ â”€â”€ */
  .actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn {
    flex: 1;
    min-width: 80px;
    padding: 10px 14px;
    border-radius: 10px;
    border: none;
    font-family: 'Mulish', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: transform 0.1s, opacity 0.2s;
    white-space: nowrap;
  }
  .btn:active { transform: scale(0.96); }
  .btn:disabled { opacity: 0.4; pointer-events: none; }

  .btn-approve  { background: var(--green); color: #000; }
  .btn-reject   { background: var(--red);   color: #fff; }
  .btn-sign     { background: var(--surface); color: var(--accent); border: 1px solid var(--accent); flex: none; }
  .btn-outline  { background: var(--surface); color: var(--text); border: 1px solid var(--border); }

  /* â”€â”€ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞĞĞ â”€â”€ */
  .handled-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: 8px;
    font-size: 12px;
    color: var(--muted);
  }

  /* â”€â”€ Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞŸĞ Ğ˜Ğ§Ğ˜Ğ â”€â”€ */
  .reasons-list {
    display: none;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
    animation: slideDown 0.15s ease;
  }
  .reasons-list.visible { display: flex; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .reason-btn {
    padding: 9px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 9px;
    color: var(--text);
    font-family: 'Mulish', sans-serif;
    font-size: 13px;
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  .reason-btn:hover { background: var(--card); border-color: var(--accent); }

  /* â”€â”€ ĞœĞĞ”ĞĞ› ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ¯ â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: flex-end;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius) var(--radius) 0 0;
    padding: 20px 16px 32px;
    width: 100%;
    max-width: 480px;
    animation: slideUp 0.2s ease;
  }
  @keyframes slideUp {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }

  .modal-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 16px;
  }

  .field { margin-bottom: 12px; }
  .field label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--muted);
    margin-bottom: 6px;
  }
  .field input {
    width: 100%;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 11px 14px;
    color: var(--text);
    font-family: 'Mulish', sans-serif;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s;
  }
  .field input:focus { border-color: var(--accent); }

  .modal-actions { display: flex; gap: 8px; margin-top: 16px; }

  /* â”€â”€ Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ â”€â”€ */
  .history-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
  }
  .history-item:last-child { border-bottom: none; }

  .history-icon {
    width: 30px; height: 30px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
  }
  .history-icon.approve { background: rgba(34,197,94,0.15); }
  .history-icon.reject  { background: rgba(239,68,68,0.15); }

  .history-text { flex: 1; }
  .history-main { font-size: 13px; font-weight: 500; line-height: 1.4; }
  .history-sub  { font-size: 11px; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ â”€â”€ */
  .rules-content {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    line-height: 1.7;
    font-size: 13px;
  }
  .rules-content b { color: var(--text); font-weight: 700; }

  /* â”€â”€ ĞŸĞ£Ğ¡Ğ¢Ğ / Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state .title { font-family: 'Unbounded', sans-serif; font-size: 14px; color: var(--text); margin-bottom: 6px; }

  .spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 40px auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Ğ¢ĞĞ¡Ğ¢ â”€â”€ */
  .toast {
    position: fixed;
    bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 18px;
    font-size: 13px;
    font-weight: 600;
    z-index: 300;
    transition: transform 0.2s ease;
    white-space: nowrap;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--green); color: var(--green); }
  .toast.error   { border-color: var(--red);   color: var(--red); }
  .toast.info    { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<!-- Ğ¨ĞĞŸĞšĞ -->
<div class="header">
  <div class="header-top">
    <div class="logo">MODER<span>.</span></div>
    <div class="queue-badge empty" id="queueBadge">0</div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('queue')">ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ</button>
    <button class="tab" onclick="switchTab('history')">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</button>
    <button class="tab" onclick="switchTab('rules')">ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°</button>
  </div>
</div>

<!-- ĞĞ§Ğ•Ğ Ğ•Ğ”Ğ¬ -->
<div class="content active" id="tab-queue">
  <div class="spinner" id="queueLoader"></div>
  <div id="queueContent" style="display:none"></div>
</div>

<!-- Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ -->
<div class="content" id="tab-history">
  <div class="spinner" id="historyLoader" style="display:none"></div>
  <div id="historyContent"></div>
</div>

<!-- ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ -->
<div class="content" id="tab-rules">
  <div class="rules-content" id="rulesContent">
    <div class="spinner"></div>
  </div>
</div>

<!-- ĞœĞĞ”ĞĞ› ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ¯ Ğ¢Ğ Ğ•ĞšĞ -->
<div class="modal-overlay" id="signModal">
  <div class="modal">
    <div class="modal-title">âœï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ñ‚Ñ€ĞµĞº</div>
    <div class="field">
      <label>Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ</label>
      <input type="text" id="signArtist" placeholder="Ğ˜Ğ¼Ñ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ">
    </div>
    <div class="field">
      <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞ°</label>
      <input type="text" id="signTitle" placeholder="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿ĞµÑĞ½Ğ¸">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeSignModal()" style="flex:1">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-approve" onclick="submitSign()" style="flex:2">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Ğ¢ĞĞ¡Ğ¢ -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Telegram WebApp
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ†Ğ²ĞµÑ‚Ğ° Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞ¼Ñƒ Telegram ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
document.documentElement.style.setProperty('--bg', tg.colorScheme === 'light' ? '#f0f0f5' : '#0a0a0f');

const initData = tg.initData;  // ÑÑ‚Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ±Ğ¾Ñ‚Ñƒ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function request(method, path, body = null) {
  const opts = {
    method,
    headers: {
      'Content-Type':   'application/json',
      'X-Init-Data':    initData,   // Telegram Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ â€” ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(path, opts);
  return r.json();
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let pendingData = { songs: [], names: [], covers: [] };
let currentAudio = null;
let currentPlayBtn = null;
let signSongId = null;  // ID Ñ‚Ñ€ĞµĞºĞ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¢Ğ°Ğ±Ñ‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['queue','history','rules'][i] === name);
  });
  document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'history') loadHistory();
  if (name === 'rules')   loadRules();
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadQueue() {
  const data = await request('GET', '/api/pending');
  if (data.error) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸', 'error'); return; }

  pendingData = data;
  const total = data.songs.length + data.names.length + data.covers.length;
  const badge = document.getElementById('queueBadge');
  badge.textContent = total;
  badge.className = 'queue-badge' + (total === 0 ? ' empty' : '');

  document.getElementById('queueLoader').style.display = 'none';
  document.getElementById('queueContent').style.display = 'block';
  renderQueue();
}

function renderQueue() {
  const el = document.getElementById('queueContent');
  const { songs, names, covers } = pendingData;
  const total = songs.length + names.length + covers.length;

  if (total === 0) {
    el.innerHTML = `<div class="empty-state">
      <div class="icon">ğŸ‰</div>
      <div class="title">ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¿ÑƒÑÑ‚Ğ°</div>
      <div>Ğ’ÑÑ‘ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾!</div>
    </div>`;
    return;
  }

  let html = '';
  songs.forEach(s  => { html += renderSongCard(s); });
  names.forEach(n  => { html += renderNameCard(n); });
  covers.forEach(c => { html += renderCoverCard(c); });
  el.innerHTML = html;
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ ĞµĞ½Ğ´ĞµÑ€ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderSongCard(s) {
  const unknown  = !s.artist || !s.title;
  const artist   = s.artist || 'â“ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½';
  const title    = s.title  || 'â“ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾';
  const handled  = s.handled_by;
  const accentCls = handled ? (handled.includes('Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾') ? 'green' : 'red') : '';

  const playerHtml = s.audio_url ? `
    <div class="player">
      <button class="play-btn" id="play-${s.id}" onclick="togglePlay('${s.id}','${escHtml(s.audio_url)}',this)">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="white">
          <polygon points="2,1 13,7 2,13" id="playIcon-${s.id}"/>
        </svg>
      </button>
      <div class="player-info">
        <div class="player-title">${escHtml(artist)} â€” ${escHtml(title)}</div>
        <div class="player-bar" onclick="seekAudio(event, '${s.id}')">
          <div class="player-progress" id="prog-${s.id}"></div>
        </div>
        <div class="player-time" id="time-${s.id}">0:00 / 0:00</div>
      </div>
    </div>` : `<div class="card-meta" style="color:var(--yellow)">âš ï¸ ĞÑƒĞ´Ğ¸Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¾</div>`;

  const unknownBadge = unknown ? `<div style="color:var(--yellow);font-size:12px;margin-bottom:10px;font-weight:600">âš ï¸ Ğ¢Ñ€ĞµĞº Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚Ğµ</div>` : '';
  const signBtn      = unknown ? `<button class="btn btn-sign" onclick="openSignModal(${s.id})">âœï¸ ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ</button>` : '';

  const actionsHtml = handled
    ? `<div class="handled-badge">âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${escHtml(handled)}</div>`
    : `<div class="actions">
        <button class="btn btn-approve" onclick="approve('song',${s.id},this)">âœ… ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ</button>
        <button class="btn btn-reject"  onclick="showReasons('song',${s.id})">âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</button>
        ${signBtn}
      </div>
      <div class="reasons-list" id="reasons-song-${s.id}"></div>`;

  return `<div class="card ${handled ? 'handled' : ''}" id="card-song-${s.id}">
    <div class="card-accent-line ${accentCls}"></div>
    <div class="card-header">
      <div class="card-type">ğŸµ ĞĞ¾Ğ²Ğ°Ñ Ğ¿ĞµÑĞ½Ñ</div>
      <div class="card-id">#${s.id}</div>
    </div>
    ${unknownBadge}
    <div class="card-title ${unknown ? 'unknown' : ''}">${escHtml(title)}</div>
    <div class="card-meta">
      ğŸ¤ <span>${escHtml(artist)}</span><br>
      ğŸ‘¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ğ»: <span>${escHtml(s.uploader || 'â€”')}</span>
    </div>
    ${playerHtml}
    ${actionsHtml}
  </div>`;
}

function renderNameCard(n) {
  const handled = n.handled_by;
  const actionsHtml = handled
    ? `<div class="handled-badge">âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${escHtml(handled)}</div>`
    : `<div class="actions">
        <button class="btn btn-approve" onclick="approve('name',${n.id},this)">âœ… ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ</button>
        <button class="btn btn-reject"  onclick="showReasons('name',${n.id})">âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div class="reasons-list" id="reasons-name-${n.id}"></div>`;

  return `<div class="card ${handled ? 'handled' : ''}" id="card-name-${n.id}">
    <div class="card-accent-line"></div>
    <div class="card-header">
      <div class="card-type">ğŸ“‹ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»ĞµĞ¹Ğ»Ğ¸ÑÑ‚Ğ°</div>
      <div class="card-id">#${n.id}</div>
    </div>
    <div class="card-title">${escHtml(n.name || 'â€”')}</div>
    <div class="card-meta">ğŸ‘¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ: <span>${escHtml(n.creator || 'â€”')}</span></div>
    ${actionsHtml}
  </div>`;
}

function renderCoverCard(c) {
  const handled   = c.handled_by;
  const coverHtml = c.cover_url
    ? `<img class="cover-img" src="${escHtml(c.cover_url)}" alt="ĞĞ±Ğ»Ğ¾Ğ¶ĞºĞ°" loading="lazy">`
    : `<div style="color:var(--yellow);font-size:12px;margin-bottom:10px">âš ï¸ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¾</div>`;

  const actionsHtml = handled
    ? `<div class="handled-badge">âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${escHtml(handled)}</div>`
    : `<div class="actions">
        <button class="btn btn-approve" onclick="approve('cover',${c.id},this)">âœ… ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ</button>
        <button class="btn btn-reject"  onclick="showReasons('cover',${c.id})">âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div class="reasons-list" id="reasons-cover-${c.id}"></div>`;

  return `<div class="card ${handled ? 'handled' : ''}" id="card-cover-${c.id}">
    <div class="card-accent-line"></div>
    <div class="card-header">
      <div class="card-type">ğŸ–¼ ĞĞ±Ğ»Ğ¾Ğ¶ĞºĞ° Ğ¿Ğ»ĞµĞ¹Ğ»Ğ¸ÑÑ‚Ğ°</div>
      <div class="card-id">#${c.id}</div>
    </div>
    <div class="card-title">${escHtml(c.name || 'â€”')}</div>
    <div class="card-meta">ğŸ‘¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ: <span>${escHtml(c.creator || 'â€”')}</span></div>
    ${coverHtml}
    ${actionsHtml}
  </div>`;
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸĞ»ĞµĞµÑ€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function togglePlay(songId, url, btn) {
  if (currentAudio && currentAudio._songId === songId) {
    if (currentAudio.paused) { currentAudio.play(); setPlayIcon(btn, true); }
    else                     { currentAudio.pause(); setPlayIcon(btn, false); }
    return;
  }
  if (currentAudio) { currentAudio.pause(); if (currentPlayBtn) setPlayIcon(currentPlayBtn, false); }

  const audio = new Audio(url);
  audio._songId = songId;
  currentAudio = audio; currentPlayBtn = btn;

  btn.classList.add('loading');
  audio.addEventListener('canplay', () => { btn.classList.remove('loading'); audio.play(); setPlayIcon(btn, true); });
  audio.addEventListener('timeupdate', () => updateProgress(audio, songId));
  audio.addEventListener('ended', () => { setPlayIcon(btn, false); document.getElementById('prog-' + songId).style.width = '0%'; });
  audio.addEventListener('error', () => { btn.classList.remove('loading'); showToast('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°ÑƒĞ´Ğ¸Ğ¾', 'error'); });
  audio.load();
}

function setPlayIcon(btn, playing) {
  const icon = btn.querySelector('polygon');
  if (!icon) return;
  icon.setAttribute('points', playing ? '3,2 7,7 3,12 5,12 11,7 5,2' : '2,1 13,7 2,13');
}

function updateProgress(audio, id) {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  const progEl = document.getElementById('prog-' + id);
  const timeEl = document.getElementById('time-' + id);
  if (progEl) progEl.style.width = pct + '%';
  if (timeEl) timeEl.textContent = fmtTime(audio.currentTime) + ' / ' + fmtTime(audio.duration);
}

function seekAudio(e, songId) {
  if (!currentAudio || currentAudio._songId !== songId) return;
  const bar = e.currentTarget;
  const pct = e.offsetX / bar.offsetWidth;
  currentAudio.currentTime = pct * currentAudio.duration;
}

function fmtTime(s) {
  s = Math.floor(s);
  return Math.floor(s / 60) + ':' + String(s % 60).padStart(2, '0');
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ â€” Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function approve(type, id, btn) {
  btn.disabled = true;
  const result = await request('POST', '/api/action', { type, id, action: 'approve' });

  if (result.error === 'already_handled') {
    showToast('âš ï¸ Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ' + result.by, 'info');
    markCardHandled(type, id, result.by);
    return;
  }
  if (result.error) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + result.error, 'error'); btn.disabled = false; return; }

  showToast('âœ… ĞŸÑ€Ğ¸Ğ½ÑÑ‚Ğ¾!', 'success');
  tg.HapticFeedback.notificationOccurred('success');
  markCardHandled(type, id, tg.initDataUnsafe?.user?.first_name || 'Ğ²Ñ‹');
  updateBadge(-1);
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ â€” Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ñ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function showReasons(type, id) {
  const reasonsEl = document.getElementById(`reasons-${type}-${id}`);
  if (reasonsEl.classList.contains('visible')) {
    reasonsEl.classList.remove('visible'); return;
  }

  const data = await request('GET', `/api/reasons/${type}`);
  const reasons = data.reasons || [];
  reasonsEl.innerHTML = reasons.map(r =>
    `<button class="reason-btn" onclick="reject('${type}',${id},'${r.code}',this)">${r.label}</button>`
  ).join('');
  reasonsEl.classList.add('visible');
}

async function reject(type, id, reasonCode, btn) {
  btn.disabled = true;
  const result = await request('POST', '/api/action', { type, id, action: 'reject', reason: reasonCode });

  if (result.error === 'already_handled') {
    showToast('âš ï¸ Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ' + result.by, 'info');
    markCardHandled(type, id, result.by);
    return;
  }
  if (result.error) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + result.error, 'error'); btn.disabled = false; return; }

  showToast('âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¾', 'error');
  tg.HapticFeedback.notificationOccurred('warning');
  markCardHandled(type, id, tg.initDataUnsafe?.user?.first_name || 'Ğ²Ñ‹');
  updateBadge(-1);
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ‚Ñ€ĞµĞºĞ°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openSignModal(songId) {
  signSongId = songId;
  document.getElementById('signArtist').value = '';
  document.getElementById('signTitle').value  = '';
  document.getElementById('signModal').classList.add('open');
  setTimeout(() => document.getElementById('signArtist').focus(), 300);
}

function closeSignModal() {
  document.getElementById('signModal').classList.remove('open');
  signSongId = null;
}

async function submitSign() {
  const artist = document.getElementById('signArtist').value.trim();
  const title  = document.getElementById('signTitle').value.trim();
  if (!artist || !title) { showToast('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¾Ğ±Ğ° Ğ¿Ğ¾Ğ»Ñ', 'error'); return; }

  const result = await request('POST', '/api/action', {
    type: 'song', id: signSongId, action: 'sign', artist, title
  });

  if (result.error) { showToast('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + result.error, 'error'); return; }

  showToast('âœï¸ Ğ¢Ñ€ĞµĞº Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½', 'success');
  closeSignModal();

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
  const songInData = pendingData.songs.find(s => s.id === signSongId);
  if (songInData) { songInData.artist = artist; songInData.title = title; }
  renderQueue();
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ğ»ĞºĞ¸ UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function markCardHandled(type, id, modName) {
  const card = document.getElementById(`card-${type}-${id}`);
  if (!card) return;
  card.classList.add('handled');
  const actionsArea = card.querySelector('.actions');
  const reasonsArea = card.querySelector('.reasons-list');
  if (actionsArea) actionsArea.outerHTML = `<div class="handled-badge">âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${escHtml(modName)}</div>`;
  if (reasonsArea) reasonsArea.remove();
}

function updateBadge(delta) {
  const badge = document.getElementById('queueBadge');
  const val   = Math.max(0, parseInt(badge.textContent || '0') + delta);
  badge.textContent = val;
  badge.className = 'queue-badge' + (val === 0 ? ' empty' : '');
}

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function showToast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadHistory() {
  const el = document.getElementById('historyContent');
  el.innerHTML = '<div class="spinner"></div>';
  const data = await request('GET', '/api/history');
  const list = data.history || [];

  if (list.length === 0) {
    el.innerHTML = `<div class="empty-state">
      <div class="icon">ğŸ“­</div>
      <div class="title">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿ÑƒÑÑ‚Ğ°</div>
      <div>Ğ•Ñ‰Ñ‘ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾</div>
    </div>`; return;
  }

  const icons = { song: 'ğŸµ', name: 'ğŸ“‹', cover: 'ğŸ–¼' };
  const labels = { song: 'ĞŸĞµÑĞ½Ñ', name: 'ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ', cover: 'ĞĞ±Ğ»Ğ¾Ğ¶ĞºĞ°' };

  el.innerHTML = list.map(h => `
    <div class="history-item">
      <div class="history-icon ${h.action}">
        ${h.action === 'approve' ? 'âœ…' : 'âŒ'}
      </div>
      <div class="history-text">
        <div class="history-main">
          ${icons[h.type] || 'â€¢'} ${labels[h.type] || ''} #${h.id}
          â€” ${h.action === 'approve' ? '<span style="color:var(--green)">Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾</span>' : '<span style="color:var(--red)">Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¾</span>'}
          ${h.reason ? `<span style="color:var(--muted);font-size:12px">(${escHtml(h.reason)})</span>` : ''}
        </div>
        <div class="history-sub">ğŸ‘¤ ${escHtml(h.mod)} Â· ${h.time}</div>
      </div>
    </div>
  `).join('');
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadRules() {
  const data = await request('GET', '/api/rules');
  const el   = document.getElementById('rulesContent');
  // ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ HTML Ñ‚ĞµĞ³Ğ¸ Ğ¸Ğ· Ğ¿Ğ¸Ñ‚Ğ¾Ğ½Ğ° Ğ² Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ğ¸Ğ´
  el.innerHTML = (data.rules || '').replace(/\n/g, '<br>');
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 ÑĞµĞºÑƒĞ½Ğ´
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function refreshQueue() {
  const data = await request('GET', '/api/pending');
  if (data.error) return;

  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğµ-Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ° (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ»ĞµĞµÑ€)
  const newSongs  = data.songs.filter(s  => !pendingData.songs.find(x  => x.id === s.id));
  const newNames  = data.names.filter(n  => !pendingData.names.find(x  => x.id === n.id));
  const newCovers = data.covers.filter(c => !pendingData.covers.find(x => x.id === c.id));

  if (newSongs.length || newNames.length || newCovers.length) {
    pendingData.songs  = [...data.songs];
    pendingData.names  = [...data.names];
    pendingData.covers = [...data.covers];
    renderQueue();
    const newCount = newSongs.length + newNames.length + newCovers.length;
    showToast(`+${newCount} Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²`, 'info');
    tg.HapticFeedback.notificationOccurred('success');
  }

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ…
  [...data.songs, ...data.names, ...data.covers].forEach(item => {
    if (item.handled_by) {
      const type = data.songs.includes(item) ? 'song' : data.names.includes(item) ? 'name' : 'cover';
      markCardHandled(type, item.id, item.handled_by);
    }
  });

  const total = data.songs.length + data.names.length + data.covers.length;
  const badge = document.getElementById('queueBadge');
  badge.textContent = total;
  badge.className = 'queue-badge' + (total === 0 ? ' empty' : '');
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¼Ğ¾Ğ´Ğ°Ğ»Ğ° Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞºÑƒ Ğ½Ğ° Ğ¾Ğ²ĞµÑ€Ğ»ĞµĞ¹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('signModal').addEventListener('click', function(e) {
  if (e.target === this) closeSignModal();
});


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ¡Ñ‚Ğ°Ñ€Ñ‚
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

loadQueue();
loadRules();
setInterval(refreshQueue, 15000);
</script>
</body>
</html>
